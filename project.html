<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è¡Œå‹•é‹å‹•ç´€éŒ„ç³»çµ±ï¼ˆæœŸæœ«å°ˆæ¡ˆï¼‰</title>

<!-- Leaflet åœ°åœ–ï¼ˆé€šè¨Šï¼šOpenStreetMapï¼‰ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 10px;
  background: #f5f5f5;
}
#map {
  height: 300px;
  margin-bottom: 12px;
  border-radius: 10px;
}
.card {
  background: #fff;
  padding: 12px;
  border-radius: 10px;
  box-shadow: 0 0 6px rgba(0,0,0,.2);
}
button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  margin-top: 10px;
  border: none;
  border-radius: 8px;
  background: #007bff;
  color: white;
}
</style>
</head>

<body>

<h2>ğŸ“± è¡Œå‹•é‹å‹•ç´€éŒ„ç³»çµ±</h2>

<div id="map"></div>

<div class="card">
  <p>ğŸ“ ä½ç½®ï¼š<span id="pos">å®šä½ing</span></p>
  <p>ğŸ›°ï¸ GPS ç²¾åº¦ï¼š<span id="acc">--</span> m</p>
  <p>ğŸ›£ï¸ ç§»å‹•è·é›¢ï¼š<span id="dist">0</span> å…¬å°º</p>
  <p>ğŸ‘£ æ­¥æ•¸ï¼š<span id="steps">0</span></p>
</div>

<button id="btnStart">é–‹å§‹é‹å‹•</button>

<script>
/* =========================================================
   1. åœ°åœ–é¡¯ç¤ºï¼ˆé€šè¨Šï¼‰
   ========================================================= */

const INIT_LAT = 24.136873;
const INIT_LNG = 120.685017;

const map = L.map("map").setView([INIT_LAT, INIT_LNG], 16);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let marker = L.marker([INIT_LAT, INIT_LNG]).addTo(map);
let polyline = null;

/* =========================================================
   2. GPS å®šä½ï¼ˆè¡Œå‹• + é€šè¨Šï¼‰
   ========================================================= */

let path = [];
let totalDistance = 0;
let firstFix = true;
let gpsWatchId = null;

function startGPS() {

  // é¿å…é‡è¤‡å•Ÿå‹• GPS
  if (gpsWatchId !== null) {
    navigator.geolocation.clearWatch(gpsWatchId);
  }

  gpsWatchId = navigator.geolocation.watchPosition(
    pos => {
      const { latitude, longitude, accuracy } = pos.coords;
      const age = Date.now() - pos.timestamp;

      if (age > 5000) return;                 // éæ¿¾ 5 ç§’å‰çš„èˆŠè³‡æ–™
      if (!firstFix && accuracy > 25) return; // éæ¿¾ä½ç²¾åº¦

      document.getElementById("pos").innerText =
        latitude.toFixed(6) + ", " + longitude.toFixed(6);
      document.getElementById("acc").innerText =
        accuracy.toFixed(1);

      // åˆå§‹å®šä½
      if (firstFix) {
        map.setView([latitude, longitude], 18);
        marker.setLatLng([latitude, longitude]);
        path = [[latitude, longitude]];
        firstFix = false;
        return;
      }

      marker.setLatLng([latitude, longitude]);
      path.push([latitude, longitude]);

      // æ›´æ–°ç§»å‹•è·¯å¾‘
      if (!polyline) {
        polyline = L.polyline(path, { weight: 5 }).addTo(map);
      } else {
        polyline.setLatLngs(path);
      }

      // è·é›¢è¨ˆç®—
      const p1 = path[path.length - 2];
      const p2 = path[path.length - 1];
      const d = calcDistance(p1, p2);

      if (d < 1.5) return; // å¿½ç•¥å°æ–¼ 1.5 å…¬å°ºçš„ç§»å‹•

      totalDistance += d;
      document.getElementById("dist").innerText =
        totalDistance.toFixed(1);
    },
    err => {
      if (err.code === 1) {
        alert("å®šä½æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹åˆ°ç€è¦½å™¨è¨­å®šä¸­å…è¨±ä½ç½®å­˜å–");
      } else if (err.code === 2) {
        alert("ç„¡æ³•å–å¾—å®šä½è³‡è¨Šï¼Œè«‹åˆ°æˆ¶å¤–å†è©¦");
      } else if (err.code === 3) {
        alert("GPS é€¾æ™‚ï¼Œè«‹ç¨å€™å†è©¦");
      } else {
        alert("GPS éŒ¯èª¤ï¼š" + err.message);
      }
    },
    { enableHighAccuracy: true, timeout: 20000 }
  );
}

/* =========================================================
   3. è·é›¢è¨ˆç®—ï¼ˆHaversineï¼‰
   ========================================================= */

function calcDistance(a, b) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;

  const dLat = toRad(b[0] - a[0]);
  const dLng = toRad(b[1] - a[1]);
  const lat1 = toRad(a[0]);
  const lat2 = toRad(b[0]);

  const h =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1) * Math.cos(lat2) *
    Math.sin(dLng / 2) ** 2;

  return 2 * R * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
}

/* =========================================================
   4. è¨ˆæ­¥å™¨ï¼ˆè¡Œå‹•ï¼šåŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨ï¼‰
   ========================================================= */

let steps = 0;
let lastPeak = 0;

function startPedometer() {
  if (typeof DeviceMotionEvent?.requestPermission === "function") {
    DeviceMotionEvent.requestPermission().then(res => {
      if (res === "granted") {
        window.addEventListener("devicemotion", onMotion);
      }
    });
  } else {
    window.addEventListener("devicemotion", onMotion);
  }
}

function onMotion(e) {
  const acc = e.acceleration || e.accelerationIncludingGravity;
  if (!acc) return;

  const total =
    Math.abs(acc.x || 0) +
    Math.abs(acc.y || 0) +
    Math.abs(acc.z || 0);

  const now = Date.now();
  if (total > 22 && now - lastPeak > 400) {
    steps++;
    document.getElementById("steps").innerText = steps;
    lastPeak = now;
  }
}

/* =========================================================
   5. ç³»çµ±æµç¨‹ï¼šé–‹å§‹é‹å‹•
   ========================================================= */

document.getElementById("btnStart").onclick = () => {
  steps = 0;
  totalDistance = 0;
  path = [];
  firstFix = true;

  if (polyline) {
    map.removeLayer(polyline);
    polyline = null;
  }

  document.getElementById("steps").innerText = "0";
  document.getElementById("dist").innerText = "0";

  startGPS();
  startPedometer();

  alert("å·²å•Ÿå‹• GPS èˆ‡è¨ˆæ­¥åŠŸèƒ½");
};
</script>

</body>
</html>
