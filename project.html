<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‹å‹•ç´€éŒ„ï¼šåœ°åœ– + è¨ˆæ­¥å™¨ï¼ˆiPhone æœ€ä½³åŒ–ï¼‰</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background: #f5f5f5;
        }

        #map {
            height: 300px;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }

        .card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
        }

        button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 10px;
            border: none;
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>

    <h2>ğŸ“± é‹å‹•ç´€éŒ„ï¼ˆGPS + è»Œè·¡ + è¨ˆæ­¥å™¨ï¼‰</h2>

    <!-- åœ°åœ– -->
    <div id="map"></div>

    <!-- é‹å‹•è³‡è¨Šå¡ -->
    <div class="card">
        <p>ğŸ§â€â™‚ï¸ æ­¥æ•¸ï¼š<span id="steps">0</span></p>
        <p>ğŸ“ ä½ç½®ï¼š<span id="status">ç­‰å¾…å®šä½ä¸­...</span></p>
        <p>ğŸ›°ï¸ ç²¾åº¦ï¼š<span id="accText">--</span> m</p>
        <p>ğŸ›£ï¸ ç§»å‹•è·é›¢ï¼š<span id="distance">0</span> å…¬å°º</p>
    </div>

    <button id="btnStart">é–‹å§‹é‹å‹•</button>

    <script>
        // ============================================================
        // 1. Leaflet åœ°åœ–åˆå§‹åŒ–
        // ============================================================
        const map = L.map("map").setView([25.033964, 121.564468], 16);

        let path = [];
        let polyline = null;
        let totalDistance = 0;

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "Â© OpenStreetMap"
        }).addTo(map);

        let marker = L.marker([25.033964, 121.564468]).addTo(map);

        let firstFix = true;

        // ============================================================
        // 2. GPS è¿½è¹¤ï¼ˆiPhone æœ€ä½³åŒ–ï¼‰
        // ============================================================
        function startGPS() {
            if (!navigator.geolocation) {
                alert("ä½ çš„æ‰‹æ©Ÿä¸æ”¯æ´ GPS å®šä½");
                return;
            }

            navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, accuracy } = pos.coords;

                    const age = Date.now() - pos.timestamp;

                    // ----------------------------
                    // â­ iPhone å¯èƒ½å›å‚³èˆŠä½ç½® â†’ å¿½ç•¥
                    // ----------------------------
                    if (age > 5000) {
                        console.log("å¿½ç•¥èˆŠè³‡æ–™ age =", age);
                        return;
                    }

                    // ----------------------------
                    // â­ éæ¿¾èª¤å·®å¤ªå¤§çš„è³‡æ–™
                    // ----------------------------
                    if (accuracy > 20) {
                        console.log("å¿½ç•¥ä½ç²¾åº¦ accuracy =", accuracy);
                        return;
                    }

                    document.getElementById("status").innerText =
                        `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                    document.getElementById("accText").innerText =
                        accuracy.toFixed(1);

                    // ----------------------------
                    // â­ ç¬¬ä¸€æ¬¡å®šä½ â†’ ç½®ä¸­
                    // ----------------------------
                    if (firstFix) {
                        map.setView([latitude, longitude], 18);
                        firstFix = false;
                    }

                    // æ›´æ–° marker
                    marker.setLatLng([latitude, longitude]);

                    // ----------------------------
                    // â­ è¨˜éŒ„è»Œè·¡
                    // ----------------------------
                    path.push([latitude, longitude]);

                    if (polyline) map.removeLayer(polyline);
                    polyline = L.polyline(path, { weight: 5 }).addTo(map);

                    // ----------------------------
                    // â­ è¨ˆç®—ç§»å‹•è·é›¢
                    // ----------------------------
                    if (path.length > 1) {
                        const p1 = path[path.length - 2];
                        const p2 = path[path.length - 1];
                        const d = getDistance(p1[0], p1[1], p2[0], p2[1]);
                        totalDistance += d;
                        document.getElementById("distance").innerText =
                            totalDistance.toFixed(1);
                    }
                },
                (err) => {
                    alert("GPS éŒ¯èª¤ï¼š" + err.message);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 20000  // â­ iPhone å¿…é ˆè¼ƒé•· timeout
                }
            );
        }

        // ============================================================
        // 3. Haversine å…¬å¼
        // ============================================================
        function getDistance(lat1, lng1, lat2, lng2) {
            function toRad(x) {
                return (x * Math.PI) / 180;
            }
            const R = 6371000;
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) *
                Math.cos(toRad(lat2)) *
                Math.sin(dLng / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ============================================================
        // 4. è¨ˆæ­¥å™¨
        // ============================================================
        let steps = 0;
        let lastPeak = 0;

        function startPedometer() {
            if (typeof DeviceMotionEvent.requestPermission === "function") {
                DeviceMotionEvent.requestPermission().then((res) => {
                    if (res === "granted") {
                        window.addEventListener("devicemotion", onMotion);
                    } else {
                        alert("ä½ æ²’æœ‰å…è¨±åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨");
                    }
                });
            } else {
                window.addEventListener("devicemotion", onMotion);
            }
        }

        function onMotion(e) {
            const acc = e.acceleration;
            if (!acc) return;

            const total = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);

            if (total > 18) {
                const now = Date.now();
                if (now - lastPeak > 300) {
                    steps++;
                    document.getElementById("steps").innerText = steps;
                    lastPeak = now;
                }
            }
        }

        // ============================================================
        // 5. æŒ‰ä¸‹ã€Œé–‹å§‹é‹å‹•ã€
        // ============================================================
        document.getElementById("btnStart").onclick = () => {
            startGPS();
            startPedometer();
            alert("é–‹å§‹é‹å‹•ï¼å·²å•Ÿå‹• GPS + è¨ˆæ­¥å™¨");
        };
    </script>
</body>
</html>
