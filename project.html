<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‹å‹•ç´€éŒ„ï¼šåœ°åœ– + è¨ˆæ­¥å™¨ï¼ˆiPhone æœ€ä½³åŒ–ï¼‰</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background: #f5f5f5;
        }

        #map {
            height: 300px;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }

        .card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
        }

        button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 10px;
            border: none;
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>

    <h2>ğŸ“± é‹å‹•ç´€éŒ„ï¼ˆGPS + è»Œè·¡ + è¨ˆæ­¥å™¨ï¼‰</h2>

    <!-- åœ°åœ– -->
    <div id="map"></div>

    <!-- é‹å‹•è³‡è¨Šå¡ -->
    <div class="card">
        <p>ğŸ§â€â™‚ï¸ æ­¥æ•¸ï¼š<span id="steps">0</span></p>
        <p>ğŸ“ ä½ç½®ï¼š<span id="status">ç­‰å¾…å®šä½ä¸­...</span></p>
        <p>ğŸ›°ï¸ ç²¾åº¦ï¼š<span id="accText">--</span> m</p>
        <p>ğŸ›£ï¸ ç§»å‹•è·é›¢ï¼š<span id="distance">0</span> å…¬å°º</p>
    </div>

    <button id="btnStart">é–‹å§‹é‹å‹•</button>

    <script>
        // ============================================================
        // 1. Leaflet åœ°åœ–åˆå§‹åŒ–ï¼ˆèµ·å§‹é»ï¼šå°ä¸­ç«è»Šç«™ï¼‰
        // ============================================================

        // å°ä¸­ç«è»Šç«™åº§æ¨™
        const INIT_LAT = 24.136873;
        const INIT_LNG = 120.685017;
        const INIT_ZOOM = 16;

        // åœ°åœ–ä¸€é–‹å§‹å…ˆé¡¯ç¤ºå°ä¸­ç«è»Šç«™
        const map = L.map("map").setView([INIT_LAT, INIT_LNG], INIT_ZOOM);

        // åœ–ç£š
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "Â© OpenStreetMap"
        }).addTo(map);

        // ä¸€é–‹å§‹å…ˆæ”¾ä¸€å€‹ã€Œå±•ç¤ºç”¨ã€ marker åœ¨å°ä¸­ç«è»Šç«™
        let marker = L.marker([INIT_LAT, INIT_LNG]).addTo(map);

        // è»Œè·¡ & è·é›¢
        let path = [];
        let polyline = null;
        let totalDistance = 0;

        // æ˜¯å¦å·²å®Œæˆç¬¬ä¸€æ¬¡ GPS æ ¡æ­£
        let firstFix = true;

        // ============================================================
        // 2. GPS è¿½è¹¤ï¼ˆiPhone æœ€ä½³åŒ–ï¼‰
        // ============================================================
        function startGPS() {
            if (!navigator.geolocation) {
                alert("ä½ çš„æ‰‹æ©Ÿä¸æ”¯æ´ GPS å®šä½");
                return;
            }

            navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, accuracy } = pos.coords;
                    const age = Date.now() - pos.timestamp;

                    // iPhone æœ‰æ™‚æœƒå›å‚³å¾ˆèˆŠçš„å®šä½ â†’ å¿½ç•¥
                    if (age > 5000) {
                        console.log("å¿½ç•¥èˆŠè³‡æ–™ age =", age);
                        return;
                    }

                    // é¡¯ç¤ºç›®å‰ç¶“ç·¯åº¦ & ç²¾åº¦
                    document.getElementById("status").innerText =
                        `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                    document.getElementById("accText").innerText =
                        accuracy.toFixed(1);

                    // =========================
                    // â­ ç¬¬ä¸€æ¬¡ GPS æ ¡æ­£
                    // =========================
                    if (firstFix) {
                        // æŠŠåœ°åœ–ä¸­å¿ƒç§»åˆ°çœŸå¯¦ä½ç½®
                        map.setView([latitude, longitude], 18);

                        // æŠŠåŸæœ¬ marker æ‹‰åˆ°çœŸå¯¦ä½ç½®
                        marker.setLatLng([latitude, longitude]);

                        // è»Œè·¡å¾ã€ŒçœŸå¯¦èµ·é»ã€é–‹å§‹ï¼ˆä¸ç®—å°ä¸­ç«è»Šç«™ï¼‰
                        path = [[latitude, longitude]];
                        firstFix = false;

                        console.log("ç¬¬ä¸€æ¬¡å®šä½å®Œæˆï¼Œæ ¡æ­£åˆ°çœŸå¯¦ä½ç½®");
                        return; // ç¬¬ä¸€æ¬¡ä¸ç®—è·é›¢
                    }

                    // =========================
                    // â­ å¾ŒçºŒå®šä½ï¼šæ­£å¼è¨˜éŒ„è»Œè·¡ & è·é›¢
                    // =========================

                    // éæ¿¾ç²¾åº¦å¤ªå·®çš„é»ï¼ˆå¯ä¾éœ€æ±‚èª¿æ•´ï¼‰
                    if (accuracy > 25) {
                        console.log("å¿½ç•¥ä½ç²¾åº¦ accuracy =", accuracy);
                        return;
                    }

                    // æ›´æ–° marker ä½ç½®
                    marker.setLatLng([latitude, longitude]);

                    // è¨˜éŒ„è»Œè·¡
                    path.push([latitude, longitude]);

                    // ç•«è·¯ç·š
                    if (polyline) map.removeLayer(polyline);
                    polyline = L.polyline(path, { weight: 5 }).addTo(map);

                    // è¨ˆç®—ç§»å‹•è·é›¢ï¼ˆHaversine å…©é»è·é›¢ï¼‰
                    if (path.length > 1) {
                        const p1 = path[path.length - 2];
                        const p2 = path[path.length - 1];
                        const d = getDistance(p1[0], p1[1], p2[0], p2[1]);
                        totalDistance += d;

                        document.getElementById("distance").innerText =
                            totalDistance.toFixed(1);
                    }
                },
                (err) => {
                    alert("GPS éŒ¯èª¤ï¼š" + err.message);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 20000  // iPhone å»ºè­° timeout é•·ä¸€é»
                }
            );
        }

        // ============================================================
        // 3. Haversine å…¬å¼ï¼šè¨ˆç®—å…©é»è·é›¢ï¼ˆå…¬å°ºï¼‰
        // ============================================================
        function getDistance(lat1, lng1, lat2, lng2) {
            function toRad(x) {
                return (x * Math.PI) / 180;
            }
            const R = 6371000; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) *
                Math.cos(toRad(lat2)) *
                Math.sin(dLng / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ============================================================
        // 4. è¨ˆæ­¥å™¨ï¼ˆDeviceMotionï¼‰
        // ============================================================
        let steps = 0;
        let lastPeak = 0;

        function startPedometer() {
            // iOS 13+ éœ€è¦ä½¿ç”¨è€…åŒæ„
            if (typeof DeviceMotionEvent !== "undefined" &&
                typeof DeviceMotionEvent.requestPermission === "function") {

                DeviceMotionEvent.requestPermission().then((res) => {
                    if (res === "granted") {
                        window.addEventListener("devicemotion", onMotion);
                    } else {
                        alert("ä½ æ²’æœ‰å…è¨±åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨ï¼Œç„¡æ³•è¨ˆæ­¥");
                    }
                });
            } else {
                // Android æˆ–è¼ƒèˆŠçš„ç€è¦½å™¨
                window.addEventListener("devicemotion", onMotion);
            }
        }

        function onMotion(e) {
            const acc = e.acceleration;
            if (!acc) return;

            const total =
                Math.abs(acc.x || 0) +
                Math.abs(acc.y || 0) +
                Math.abs(acc.z || 0);

            // ç°¡å–®å³°å€¼åµæ¸¬åˆ¤æ–·èµ°ä¸€æ­¥
            if (total > 18) {
                const now = Date.now();
                if (now - lastPeak > 300) { // 300ms é¿å…åŒä¸€æ­¥å¤šæ¬¡è§¸ç™¼
                    steps++;
                    document.getElementById("steps").innerText = steps;
                    lastPeak = now;
                }
            }
        }

        // ============================================================
        // 5. æŒ‰ä¸‹ã€Œé–‹å§‹é‹å‹•ã€
        // ============================================================
        document.getElementById("btnStart").onclick = () => {
            // æ¯æ¬¡é–‹å§‹å‰ï¼Œé‡ç½®è¨ˆæ•¸
            steps = 0;
            lastPeak = 0;
            totalDistance = 0;
            path = [];
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
            document.getElementById("steps").innerText = "0";
            document.getElementById("distance").innerText = "0";

            // å›åˆ°ã€Œç­‰å¾…ç¬¬ä¸€æ¬¡ GPS æ ¡æ­£ã€ç‹€æ…‹
            firstFix = true;

            startGPS();
            startPedometer();
            alert("é–‹å§‹é‹å‹•ï¼å·²å•Ÿå‹• GPS + è¨ˆæ­¥å™¨");
        };
    </script>
</body>
</html>

