<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‹å‹•ç´€éŒ„ï¼šåœ°åœ– + è¨ˆæ­¥å™¨</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet/dist/leaflet.css"
    />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background: #f5f5f5;
        }

        #map {
            height: 300px;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }

        .card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
        }

        button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 10px;
            border: none;
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>

    <h2>ğŸ“± é‹å‹•ç´€éŒ„ï¼ˆGPS + è»Œè·¡ + è¨ˆæ­¥å™¨ï¼‰</h2>

    <!-- åœ°åœ– -->
    <div id="map"></div>

    <!-- é‹å‹•è³‡è¨Šå¡ -->
    <div class="card">
        <p>ğŸ§â€â™‚ï¸ æ­¥æ•¸ï¼š<span id="steps">0</span></p>
        <p>ğŸ“ ä½ç½®ï¼š<span id="status">ç­‰å¾…å®šä½ä¸­...</span></p>
        <p>ğŸ›£ï¸ ç§»å‹•è·é›¢ï¼š<span id="distance">0</span> å…¬å°º</p>
    </div>

    <button id="btnStart">é–‹å§‹é‹å‹•</button>

    <script>
        // -----------------------------
        //  1. åˆå§‹åŒ–åœ°åœ–
        // -----------------------------
        const map = L.map("map").setView([25.033964, 121.564468], 16);

        let path = []; // å„²å­˜æ‰€æœ‰ç¶“ç·¯åº¦
        let polyline = null;
        let totalDistance = 0; // ç´¯ç©è·é›¢

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "Â© OpenStreetMap"
        }).addTo(map);

        let marker = L.marker([25.033964, 121.564468]).addTo(map);

        // -----------------------------
        //  2. GPS å®šä½èˆ‡è»Œè·¡
        // -----------------------------
        function startGPS() {
            if (!navigator.geolocation) {
                alert("ä½ çš„æ‰‹æ©Ÿä¸æ”¯æ´ GPS å®šä½");
                return;
            }

            navigator.geolocation.watchPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const accuracy = pos.coords.accuracy;

                    document.getElementById("status").innerText =
                        `${lat.toFixed(6)}, ${lng.toFixed(6)}ï¼ˆèª¤å·® ${accuracy}mï¼‰`;

                    // æ›´æ–° Marker
                    marker.setLatLng([lat, lng]);
                    map.setView([lat, lng]);

                    // è¨˜éŒ„è·¯ç·š
                    path.push([lat, lng]);

                    // ç•«å‡ºè»Œè·¡
                    if (polyline) map.removeLayer(polyline);
                    polyline = L.polyline(path, { weight: 5 }).addTo(map);

                    // è¨ˆç®—è·é›¢ï¼ˆåªåœ¨ç¬¬äºŒé»ä¹‹å¾Œæ‰ç®—ï¼‰
                    if (path.length > 1) {
                        const p1 = path[path.length - 2];
                        const p2 = path[path.length - 1];
                        const d = getDistance(p1[0], p1[1], p2[0], p2[1]);
                        totalDistance += d;
                        document.getElementById("distance").innerText = totalDistance.toFixed(1);
                    }
                },
                (err) => {
                    alert("GPS éŒ¯èª¤ï¼š" + err.message);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );
        }

        // ç¶“ç·¯åº¦è·é›¢å…¬å¼ï¼ˆhaversineï¼‰
        function getDistance(lat1, lng1, lat2, lng2) {
            function toRad(x) {
                return (x * Math.PI) / 180;
            }
            const R = 6371000;
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) *
                    Math.cos(toRad(lat2)) *
                    Math.sin(dLng / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // -----------------------------
        //  3. è¨ˆæ­¥å™¨ï¼ˆåŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨ï¼‰
        // -----------------------------
        let steps = 0;
        let lastPeak = 0;

        function startPedometer() {
            if (typeof DeviceMotionEvent.requestPermission === "function") {
                // iPhone éœ€è¦æŒ‰éˆ•æˆæ¬Š
                DeviceMotionEvent.requestPermission().then((res) => {
                    if (res === "granted") {
                        window.addEventListener("devicemotion", onMotion);
                    } else {
                        alert("ä½ æ²’æœ‰å…è¨±åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨");
                    }
                });
            } else {
                // Android ç›´æ¥ç”¨
                window.addEventListener("devicemotion", onMotion);
            }
        }

        function onMotion(e) {
            const acc = e.acceleration;
            if (!acc) return;

            const total = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);

            if (total > 18) {  // éé–€æª» â†’ è¨ˆç‚ºä¸€æ­¥
                const now = Date.now();
                if (now - lastPeak > 300) { // é˜²æ­¢å¤ªå¿«é€£è·³
                    steps++;
                    document.getElementById("steps").innerText = steps;
                    lastPeak = now;
                }
            }
        }

        // -----------------------------
        // 4. æŒ‰éˆ•é–‹å§‹
        // -----------------------------
        document.getElementById("btnStart").onclick = () => {
            startGPS();
            startPedometer();
            alert("é–‹å§‹é‹å‹•ï¼å·²å•Ÿå‹• GPS + è¨ˆæ­¥å™¨");
        };
    </script>
</body>
</html>
